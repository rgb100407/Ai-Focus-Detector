import cv2
import mediapipe as mp
import time
import winsound

# Initialize mediapipe face mesh
mp_face_mesh = mp.solutions.face_mesh
face_mesh = mp_face_mesh.FaceMesh(refine_landmarks=True)

# For drawing face landmarks
mp_drawing = mp.solutions.drawing_utils

# Capture from webcam
cap = cv2.VideoCapture(0)

focused = True
last_distracted_time = None

print("AI Focus Detector is running... Press 'q' to quit.")

while cap.isOpened():
    success, frame = cap.read()
    if not success:
        print("Ignoring empty camera frame.")
        continue

    # Flip the frame horizontally for mirror view
    frame = cv2.flip(frame, 1)
    rgb_frame = cv2.cvtColor(frame, cv2.COLOR_BGR2RGB)

    # Process with FaceMesh
    results = face_mesh.process(rgb_frame)

    if results.multi_face_landmarks:
        # Assuming one face
        face_landmarks = results.multi_face_landmarks[0]

        # Get left and right eye landmarks
        left_eye = [face_landmarks.landmark[i] for i in [33, 133]]  # approx left eye corners
        right_eye = [face_landmarks.landmark[i] for i in [362, 263]]  # approx right eye corners

        # Calculate eye width (approximation of openness/focus)
        left_eye_width = abs(left_eye[0].x - left_eye[1].x)
        right_eye_width = abs(right_eye[0].x - right_eye[1].x)

        # Heuristic: if eyes too narrow or not visible => distracted
        if left_eye_width < 0.015 or right_eye_width < 0.015:
            if focused:
                last_distracted_time = time.time()
                focused = False
            else:
                # Check if distracted for more than 5 seconds
                if time.time() - last_distracted_time > 5:
                    cv2.putText(frame, "DISTRACTED! ðŸ””", (50, 100),
                                cv2.FONT_HERSHEY_SIMPLEX, 1.5, (0, 0, 255), 3)
                    winsound.Beep(1000, 500)
        else:
            focused = True
            cv2.putText(frame, "FOCUSED ðŸ˜Š", (50, 100),
                        cv2.FONT_HERSHEY_SIMPLEX, 1.5, (0, 255, 0), 3)
    else:
        # No face detected
        if focused:
            last_distracted_time = time.time()
            focused = False
        else:
            if time.time() - last_distracted_time > 5:
                cv2.putText(frame, "NO FACE DETECTED! ðŸ””", (50, 100),
                            cv2.FONT_HERSHEY_SIMPLEX, 1.5, (0, 0, 255), 3)
                winsound.Beep(1000, 500)

    # Display
    cv2.imshow('AI Focus Detector', frame)

    if cv2.waitKey(1) & 0xFF == ord('q'):
        break

cap.release()
cv2.destroyAllWindows()
